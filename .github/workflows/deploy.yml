# Reusable deployment workflow shared by dev and prod.
# Called from deploy-dev.yml and deploy-prod.yml after build.yml produces artifacts.
#
# Optimizations applied (see ADR-025):
#   - Conditional Bicep infra deploy (skip when infra/ unchanged)
#   - Cached Function App npm install + Prisma engines
#   - Parallel Function App + SWA deployment
#   - Sparse checkout in deploy job
name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: GitHub environment name (dev / production)
        required: true
        type: string
      env_suffix:
        description: Short env label used in resource names (dev / prod)
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      # Sparse checkout — deploy only needs infra/, prisma schema, and API packaging files
      - uses: actions/checkout@v6
        with:
          sparse-checkout: |
            infra
            apps/api/prisma
            apps/api/host.json
            apps/api/package.json
          fetch-depth: 2

      - uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/out/

      - uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/dist/

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Set Deployment Name
        run: echo "DEPLOY_NAME=aop-${{ github.run_number }}-${GITHUB_SHA::7}" >> $GITHUB_ENV

      # Detect whether infra/ files changed to skip expensive Bicep deploy
      - name: Check for Infrastructure Changes
        id: infra-check
        run: |
          if git diff --name-only HEAD~1 -- infra/ 2>/dev/null | grep -q .; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Infrastructure files changed — will deploy Bicep"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No infrastructure changes — skipping Bicep deploy"
          fi

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Resource Group
        if: steps.infra-check.outputs.changed == 'true'
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az group create --name rg-aops-${{ inputs.env_suffix }} --location centralus

      - name: Deploy Infrastructure
        if: steps.infra-check.outputs.changed == 'true'
        uses: azure/CLI@v2
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
          TBA_API_KEY: ${{ secrets.TBA_API_KEY }}
        with:
          inlineScript: |
            az deployment group create \
              --resource-group rg-aops-${{ inputs.env_suffix }} \
              --name ${{ env.DEPLOY_NAME }} \
              --parameters infra/parameters/${{ inputs.env_suffix }}.bicepparam

      - name: Ensure DNS Resource Group
        if: steps.infra-check.outputs.changed == 'true'
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az group create --name rg-aops-global --location centralus

      - name: Deploy DNS Records
        if: steps.infra-check.outputs.changed == 'true'
        uses: azure/CLI@v2
        env:
          ENVIRONMENT_NAME: ${{ inputs.env_suffix }}
        with:
          inlineScript: |
            export SWA_DEFAULT_HOSTNAME=$(az staticwebapp show \
              --name stapp-aops-${{ inputs.env_suffix }} \
              --query defaultHostname -o tsv)

            if [ "${{ inputs.env_suffix }}" = "prod" ]; then
              export SWA_RESOURCE_ID=$(az staticwebapp show \
                --name stapp-aops-${{ inputs.env_suffix }} \
                --query id -o tsv)
            fi

            az deployment group create \
              --resource-group rg-aops-global \
              --name dns-${{ inputs.env_suffix }}-${{ env.DEPLOY_NAME }} \
              --parameters infra/parameters/dns.bicepparam

      - name: Grant Deployer Key Vault Access
        uses: azure/CLI@v2
        with:
          inlineScript: |
            DEPLOYER_OID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
            KV_ID=$(az keyvault show --name kv-aops-${{ inputs.env_suffix }} --query id -o tsv)
            az role assignment create \
              --assignee-object-id $DEPLOYER_OID \
              --assignee-principal-type ServicePrincipal \
              --role "Key Vault Secrets User" \
              --scope $KV_ID 2>/dev/null || true

      - name: Run Database Migrations
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            --resource-group rg-aops-${{ inputs.env_suffix }} \
            --name psql-aops-${{ inputs.env_suffix }} \
            --rule-name AllowGitHubRunner \
            --start-ip-address $RUNNER_IP \
            --end-ip-address $RUNNER_IP

          export DATABASE_URL=$(az keyvault secret show \
            --vault-name kv-aops-${{ inputs.env_suffix }} \
            --name DatabaseUrl \
            --query value -o tsv)
          cd apps/api
          npx --yes prisma@^6 migrate deploy

      - name: Cleanup Postgres Firewall Rule
        if: always()
        run: |
          az postgres flexible-server firewall-rule delete \
            --resource-group rg-aops-${{ inputs.env_suffix }} \
            --name psql-aops-${{ inputs.env_suffix }} \
            --rule-name AllowGitHubRunner \
            --yes || true

      # Cache npm dependencies for Function App packaging — avoids cold
      # install when apps/api/package.json hasn't changed.
      - name: Cache Function App Dependencies
        id: fa-cache
        uses: actions/cache@v4
        with:
          path: /tmp/api-deploy/node_modules
          key: fa-deps-${{ runner.os }}-${{ hashFiles('apps/api/package.json') }}

      - name: Package Function App
        run: |
          STAGING=/tmp/api-deploy
          mkdir -p $STAGING

          cp -r apps/api/dist $STAGING/dist
          cp apps/api/host.json $STAGING/

          # Strip devDependencies (contains workspace:* protocol npm can't resolve)
          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('apps/api/package.json', 'utf8'));
            delete pkg.devDependencies;
            require('fs').writeFileSync('$STAGING/package.json', JSON.stringify(pkg, null, 2));
          "

          cp -r apps/api/prisma $STAGING/

          cd $STAGING

          # Only run npm install if cache missed
          if [ "${{ steps.fa-cache.outputs.cache-hit }}" != "true" ]; then
            npm install --omit=dev
          fi

          npx --yes prisma@^6 generate

          zip -r $GITHUB_WORKSPACE/api-deploy.zip dist/ host.json package.json node_modules/ \
            -x "node_modules/.cache/*"

      # Deploy Function App and Static Web App in parallel using background processes
      - name: Deploy Function App & Static Web App
        run: |
          # Get SWA deployment token
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name stapp-aops-${{ inputs.env_suffix }} \
            --query "properties.apiKey" -o tsv)
          echo "::add-mask::$SWA_TOKEN"

          # Deploy Function App (background)
          az functionapp deployment source config-zip \
            --resource-group rg-aops-${{ inputs.env_suffix }} \
            --name func-aops-${{ inputs.env_suffix }} \
            --src api-deploy.zip &
          FA_PID=$!

          # Deploy Static Web App (background) — using npx to call the SWA CLI
          npx --yes @azure/static-web-apps-cli@latest deploy \
            apps/web/out \
            --deployment-token "$SWA_TOKEN" \
            --env production &
          SWA_PID=$!

          # Wait for both deployments and capture exit codes
          FA_EXIT=0
          SWA_EXIT=0
          wait $FA_PID || FA_EXIT=$?
          wait $SWA_PID || SWA_EXIT=$?

          if [ $FA_EXIT -ne 0 ]; then
            echo "::error::Function App deployment failed (exit code $FA_EXIT)"
          fi
          if [ $SWA_EXIT -ne 0 ]; then
            echo "::error::Static Web App deployment failed (exit code $SWA_EXIT)"
          fi

          # Fail the step if either deployment failed
          [ $FA_EXIT -eq 0 ] && [ $SWA_EXIT -eq 0 ]

      - name: Cleanup Old Deployments
        if: always()
        uses: azure/CLI@v2
        with:
          inlineScript: |
            for RG in "rg-aops-${{ inputs.env_suffix }}" "rg-aops-global"; do
              echo "Pruning deployments in $RG (keeping latest 10)..."
              az deployment group list \
                --resource-group "$RG" \
                --query "[?properties.provisioningState!='Running'] | sort_by(@,&properties.timestamp)[].name" -o tsv \
              | head -n -10 \
              | xargs -r -I{} az deployment group delete \
                  --resource-group "$RG" --name {} --no-wait
            done
