# Post-deploy integration and load tests against an ephemeral Azure environment.
# Triggered after a successful Deploy Dev workflow run.
# Spins up rg-aops-test, deploys the same build artifacts, runs tests, tears down.
name: Post-Deploy Tests

on:
  workflow_run:
    workflows: ['Deploy Dev']
    types: [completed]
    branches: [dev]

jobs:
  deploy-test-env:
    name: Deploy Test Environment
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: test
    permissions:
      id-token: write
      contents: read
      actions: read
    outputs:
      fa_hostname: ${{ steps.capture-hostname.outputs.fa_hostname }}
    steps:
      - name: Sparse Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            infra
            apps/api/prisma
            apps/api/host.json
            apps/api/package.json

      - name: Download API Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: apps/api/dist/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Web Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/out/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az group create --name rg-aops-test --location centralus

      - name: Deploy Infrastructure
        uses: azure/CLI@v2
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
          TBA_API_KEY: ${{ secrets.TBA_API_KEY }}
        with:
          inlineScript: |
            az deployment group create \
              --resource-group rg-aops-test \
              --name test-${{ github.run_number }} \
              --parameters infra/parameters/test.bicepparam

      - name: Grant Deployer Key Vault Access
        uses: azure/CLI@v2
        with:
          inlineScript: |
            DEPLOYER_OID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
            KV_ID=$(az keyvault show --name kv-aops-test --query id -o tsv)
            az role assignment create \
              --assignee-object-id $DEPLOYER_OID \
              --assignee-principal-type ServicePrincipal \
              --role "Key Vault Secrets User" \
              --scope $KV_ID 2>/dev/null || true

      - name: Run Database Migrations
        run: |
          RUNNER_IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            --resource-group rg-aops-test \
            --name psql-aops-test \
            --rule-name AllowGitHubRunner \
            --start-ip-address $RUNNER_IP \
            --end-ip-address $RUNNER_IP

          export DATABASE_URL=$(az keyvault secret show \
            --vault-name kv-aops-test \
            --name DatabaseUrl \
            --query value -o tsv)
          cd apps/api
          npx --yes prisma@^6 migrate deploy

      - name: Cleanup Postgres Firewall Rule
        if: always()
        run: |
          az postgres flexible-server firewall-rule delete \
            --resource-group rg-aops-test \
            --name psql-aops-test \
            --rule-name AllowGitHubRunner \
            --yes || true

      - name: Package Function App
        run: |
          STAGING=/tmp/api-deploy
          mkdir -p $STAGING

          cp -r apps/api/dist $STAGING/dist
          cp apps/api/host.json $STAGING/

          # Strip devDependencies (contains workspace:* protocol npm can't resolve)
          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('apps/api/package.json', 'utf8'));
            delete pkg.devDependencies;
            require('fs').writeFileSync('$STAGING/package.json', JSON.stringify(pkg, null, 2));
          "

          cp -r apps/api/prisma $STAGING/

          cd $STAGING
          npm install --omit=dev
          npx --yes prisma@^6 generate

          zip -r $GITHUB_WORKSPACE/api-deploy.zip dist/ host.json package.json node_modules/ \
            -x "node_modules/.cache/*"

      - name: Deploy Function App & Static Web App
        run: |
          # Get SWA deployment token
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name stapp-aops-test \
            --query "properties.apiKey" -o tsv)
          echo "::add-mask::$SWA_TOKEN"

          # Deploy Function App (background)
          az functionapp deployment source config-zip \
            --resource-group rg-aops-test \
            --name func-aops-test \
            --src api-deploy.zip &
          FA_PID=$!

          # Deploy Static Web App (background)
          npx --yes @azure/static-web-apps-cli@latest deploy \
            apps/web/out \
            --deployment-token "$SWA_TOKEN" \
            --env production &
          SWA_PID=$!

          # Wait for both deployments
          FA_EXIT=0
          SWA_EXIT=0
          wait $FA_PID || FA_EXIT=$?
          wait $SWA_PID || SWA_EXIT=$?

          if [ $FA_EXIT -ne 0 ]; then
            echo "::error::Function App deployment failed (exit code $FA_EXIT)"
          fi
          if [ $SWA_EXIT -ne 0 ]; then
            echo "::error::Static Web App deployment failed (exit code $SWA_EXIT)"
          fi

          [ $FA_EXIT -eq 0 ] && [ $SWA_EXIT -eq 0 ]

      - name: Capture FA Hostname
        id: capture-hostname
        uses: azure/CLI@v2
        with:
          inlineScript: |
            HOSTNAME=$(az functionapp show \
              --name func-aops-test \
              --resource-group rg-aops-test \
              --query defaultHostName -o tsv)
            echo "fa_hostname=$HOSTNAME" >> $GITHUB_OUTPUT
            echo "Function App hostname: $HOSTNAME"

  integration:
    name: Integration Tests
    needs: deploy-test-env
    runs-on: ubuntu-latest
    env:
      API_BASE_URL: https://${{ needs.deploy-test-env.outputs.fa_hostname }}
      TBA_API_KEY: ${{ secrets.TBA_API_KEY }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Run Integration Tests
        working-directory: tests
        run: |
          npx vitest run \
            --config integration/vitest.config.ts \
            --reporter=default \
            --reporter=junit \
            --outputFile=test-results/integration.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-results
          path: tests/test-results/

  load:
    name: Load Tests
    needs: [deploy-test-env, integration]
    runs-on: ubuntu-latest
    env:
      API_BASE_URL: https://${{ needs.deploy-test-env.outputs.fa_hostname }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Smoke Test
        run: k6 run tests/load/scripts/smoke.js

      - name: Run Load Test
        run: |
          mkdir -p tests/load/test-results
          k6 run tests/load/scripts/load.js --out json=tests/load/test-results/load.json

      - name: Upload Load Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-results
          path: tests/load/test-results/

  teardown:
    name: Teardown Test Environment
    needs: [deploy-test-env, integration, load]
    if: always()
    runs-on: ubuntu-latest
    environment: test
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete Resource Group
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az group delete --name rg-aops-test --yes --no-wait
            echo "Resource group rg-aops-test deletion initiated"

  report:
    name: Report Failures
    needs: [integration, load, teardown]
    if: always() && (needs.integration.result == 'failure' || needs.load.result == 'failure')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Download Test Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: Parse Results and Create Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          INTEGRATION_STATUS="${{ needs.integration.result }}"
          LOAD_STATUS="${{ needs.load.result }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          BODY="## Post-Deploy Test Failures

          **Workflow Run:** [#${{ github.run_number }}]($RUN_URL)
          **Triggered by:** Deploy Dev run #${{ github.event.workflow_run.run_number }}
          **Branch:** \`dev\`

          ### Results
          | Suite | Status |
          |---|---|
          | Integration Tests | \`$INTEGRATION_STATUS\` |
          | Load Tests | \`$LOAD_STATUS\` |

          ### Details
          Check the [workflow run]($RUN_URL) for full logs and test artifacts.
          "

          # Check for JUnit XML
          if [ -f artifacts/integration-results/integration.xml ]; then
            FAILURES=$(grep -c 'failure' artifacts/integration-results/integration.xml 2>/dev/null || echo "unknown")
            BODY="$BODY

          **Integration test failures:** $FAILURES (from JUnit XML)"
          fi

          gh issue create \
            --title "[Test] Post-deploy failures (run #${{ github.run_number }})" \
            --label "bug,automated-test" \
            --body "$BODY"
